<div class="sect1">
<h2 id="topics/variables-8">Custom Variable Stores</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When writing <a href="https://docs.unity3d.com/Manual/CreatingComponents.html" target="_blank" rel="noopener">custom components</a> it is often useful to expose the object and its properties to the variables system. This can be done by implementing the <a href="#reference/i-variable-store.html">IVariableStore</a> interface. This interface is fairly straight forward and is perfect for small helper classes that expose a few properties. For example, consider an inventory item that consists of an object and count:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">using PiRhoSoft.CompositionEngine
using UnityEngine;

namespace PiRhoSoft.CompositionExample
{
	public class InventoryItem : IVariableStore
	{
		public Item Item;
		public int Count;

		private static readonly string[] _names = new string[] { nameof(Item), nameof(Count) };

		public IList&lt;string&gt; GetVariableNames() =&gt; _names;
		public VariableValue GetVariable(string name)
		{
			switch (name)
			{
				case nameof(Item): return VariableValue.Create(Item);
				case nameof(Count): return VariableValue.Create(Count);
				default: return VariableValue.Empty;
			}
		}

		public SetVariableResult SetVariable(string name, VariableValue value)
		{
			switch (name)
			{
				case nameof(Item): return SetVariableResult.ReadOnly;
				case nameof(Count):
					if (value.TryGetInt(out int count))
					{
						Count = count;
						return SetVariableResult.Success;
					}
					else
					{
						return SetVariableResult.TypeMismatch;
					}
				default: return SetVariableResult.NotFound;
			}
		}
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more complex classes with many properties, or classes that want a mix of code defined and editor defined properties, it is much simpler and more flexible to use the <a href="#reference">mapped-variable-store,MappedVariableStore</a> class. This can be used directly or by deriving from the <a href="#reference/variable-set-component.html">VariableSetComponent</a> (for <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.html" target="_blank" rel="noopener">MonoBehaviours</a>) or <a href="#reference/variable-set-asset.html">VariableSetAsset</a> (for <a href="https://docs.unity3d.com/ScriptReference/ScriptableObject.html" target="_blank" rel="noopener">ScriptableObjects</a>). These classes can also be used directly without subclassing as described in <a href="#topics/variables-3.html">Defining Variables</a> but become more powerful when extended. Deriving automatically adds <a href="#reference/variable-schema.html">VariableSchema</a> support, <a href="#reference/i-variable-store.html">IVariableStore</a> access for all schema and code defined properties, variable resetting with <a href="#reference/i-variable-reset.html">IVariableReset</a>, and full editor and <a href="#topics/graphs-5.html">watch window</a> integration.</p>
</div>
<div class="paragraph">
<p>To expose code defined fields and properties to the variables system, the <a href="reference/mapped-variable-attribute.html">MappedVariableAttribute</a> is used. This is as simple as adding the attribute to a field or property on a class derived from <a href="#reference/variable-set-component.html">VariableSetComponent</a> or <a href="#reference/variable-set-asset.html">VariableSetAsset</a>. The <a href="reference/mapped-variable-attribute.html">MappedVariableAttribute</a> can optionally be passed a parameter indicating whether the variable is allowed to be set by the variables system. A property without a setter will automatically be read only.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">using PiRhoSoft.CompositionEngine
using UnityEngine;

namespace PiRhoSoft.CompositionExample
{
	public class Player : VariableSetComponent
	{
		[MappedVariable] public string Name;
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this player is placed on the global store (possibly using <a href="#reference/variable-link.html">VariableLink</a>) with the name <code>"Player"</code>, <em>Name</em> could then be accessed with a <a href="#reference/variable-reference.html">VariableReference</a> set to <code>global.Player.Name</code>.</p>
</div>
<div class="paragraph">
<p>All <a href="#reference/variable-type.html">VariableTypes</a> are supported with <a href="reference/mapped-variable-attribute.html">MappedVariableAttribute</a> including <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.ilist-1?view=netframework-4.8" target="_blank" rel="noopener">IList&lt;T&gt;</a> implementors when <em>T</em> is itself a valid <a href="#reference/variable-type.html">VariableType</a>. Here is a slightly expanded example of Player using the InventoryItem class defined above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">using PiRhoSoft.CompositionEngine
using UnityEngine;

namespace PiRhoSoft.CompositionExample
{
	public class Player : VariableSetComponent
	{
		[MappedVariable] public string Name;
		[MappedVariable] public List&lt;InventoryItem&gt; Inventory = new List&lt;InventoryItem&gt;();
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Items in the Player`s inventory can now be accessed with <code>global.Player.Inventory</code>. Getting the <code>Count</code> of the first item would be done using <code>global.Player.Inventory[0].Count</code>.</p>
</div>
<div class="sect2">
<h3 id="_exposing_third_party_classes">Exposing Third Party Classes</h3>
<div class="paragraph">
<p>In situations where an <a href="https://docs.unity3d.com/ScriptReference/Object.html" target="_blank" rel="noopener">Object</a> class cannot be changed to implement <a href="#reference/i-variable-store.html">IVariableStore</a>, like for a third party or built in <a href="https://docs.unity3d.com/ScriptReference/Component.html" target="_blank" rel="noopener">Component</a>, the <a href="#reference/class-map-1.html">ClassMap</a> class is provided. By deriving from this class and registering an instance with <a href="#reference/class-map.html">ClassMap</a> properties can be exposed to the variables system, making them available in <a href="#topics/variables-4.html">VariableReferences and Expressions</a>. The following is an example of the <code>InventoryItem</code> class defined using a <a href="#reference/class-map.html">ClassMap</a> instead of with <a href="#reference/i-variable-store.html">IVariableStore</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">using PiRhoSoft.CompositionEngine
using UnityEngine;

namespace PiRhoSoft.CompositionExample
{
	public class InventoryItem
	{
		public Item Item;
		public int Count;

		[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.AfterAssembliesLoaded)]
		private static void RegisterMap()
		{
			ClassMap.Add(new InventoryItemMap());
		}
	}

	public class InventoryItemMap : ClassMap&lt;InventoryItem&gt;
	{
		private static List&lt;string&gt; _names = new List&lt;string&gt;
		{
			nameof(InventoryItem.Item),
			nameof(InventoryItem.Count)
		};

		public override IList&lt;string&gt; GetVariableNames()
		{
			return _names;
		}

		public override VariableValue GetVariable(InventoryItem obj, string name)
		{
			switch (name)
			{
				case nameof(InventoryItem.Item): return VariableValue.Create(obj.Item);
				case nameof(InventoryItem.Count): return VariableValue.Create(obj.Count);
			}

			return VariableValue.Empty;
		}

		public override SetVariableResult SetVariable(InventoryItem obj, string name, VariableValue value)
		{
			switch (name)
			{
				case nameof(InventoryItem.Item): if (value.TryGetReference&lt;Item&gt;(out var item)) { obj.Item = item; return SetVariableResult.Success; } return SetVariableResult.TypeMismatch;
				case nameof(InventoryItem.Count): if (value.TryGetInt(out var count)) { obj.Count = count; return SetVariableResult.Success; } return SetVariableResult.TypeMismatch;
			}

			return SetVariableResult.NotFound;
		}
	}
}</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>